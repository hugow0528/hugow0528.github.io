<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>文章幻燈片 Pro</title>

    <!-- Google Fonts: Noto Serif TC -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;700&family=Segoe+UI:wght@400;600;700&display=swap" rel="stylesheet">
    
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Libraries for Export Functionality -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://unpkg.com/docx@8.5.0/build/index.js"></script>


    <style>
        /* --- Base and Font Setup --- */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Noto Serif TC', serif;
            background: linear-gradient(135deg, #f0f4f8 0%, #d9e2ec 100%);
            min-height: 100vh;
            padding: 20px;
            color: #2d3748;
            overflow-x: hidden;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        /* --- Header and Typography --- */
        header {
            text-align: center;
            padding: 40px 0 20px;
            margin-bottom: 20px;
        }
        
        h1 {
            font-size: 2.8rem;
            font-weight: 700;
            color: #2c5282;
            margin-bottom: 15px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
            background: linear-gradient(to right, #2c5282, #4a5568);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .subtitle {
            font-size: 1.2rem;
            color: #4a5568;
            max-width: 700px;
            margin: 0 auto;
            line-height: 1.6;
        }

        h2 {
            font-size: 1.8rem;
            font-weight: 700;
            color: #2c5282;
        }
        
        /* --- App Layout --- */
        .app-container {
            display: flex;
            flex-direction: column;
            gap: 30px;
            background: white;
            border-radius: 20px;
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.15);
            overflow: hidden;
            margin-bottom: 40px;
        }
        
        .input-section, .slides-section {
            padding: 30px;
        }

        .input-section {
            background: #f8fafc;
            border-bottom: 1px solid #e2e8f0;
        }
        
        .input-header {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
            gap: 15px;
        }
        
        .input-header i {
            font-size: 28px;
            color: #3182ce;
        }
        
        /* --- Form Elements and Controls --- */
        .input-container {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        textarea {
            width: 100%;
            height: 200px;
            padding: 20px;
            border: 2px solid #cbd5e0;
            border-radius: 12px;
            font-size: 16px;
            line-height: 1.6;
            resize: vertical;
            transition: all 0.3s;
            background: white;
            font-family: 'Noto Serif TC', serif;
        }
        
        textarea:focus {
            outline: none;
            border-color: #3182ce;
            box-shadow: 0 0 0 4px rgba(66, 153, 225, 0.2);
        }
        
        .char-count {
            text-align: right;
            color: #718096;
            font-size: 14px;
            font-weight: 500;
            font-family: 'Segoe UI', sans-serif;
        }
        
        .controls {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 15px;
            margin-top: 20px;
        }
        
        .btn {
            padding: 14px 25px;
            border: none;
            border-radius: 50px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            font-family: 'Segoe UI', sans-serif;
            font-weight: 600;
            flex-shrink: 0;
        }
        
        .btn-primary {
            background: linear-gradient(to right, #3182ce, #2b6cb0);
            color: white;
        }
        .btn-primary:hover {
            background: linear-gradient(to right, #2b6cb0, #2c5282);
            transform: translateY(-3px);
            box-shadow: 0 6px 15px rgba(43, 108, 176, 0.35);
        }
        
        .btn-secondary {
            background: linear-gradient(to right, #e53e3e, #c53030);
            color: white;
        }
        .btn-secondary:hover {
            background: linear-gradient(to right, #c53030, #9b2c2c);
            transform: translateY(-3px);
            box-shadow: 0 6px 15px rgba(197, 48, 48, 0.35);
        }

        .btn-tertiary {
            background: linear-gradient(to right, #6b7280, #4b5563);
            color: white;
        }
        .btn-tertiary:hover {
            background: linear-gradient(to right, #4b5563, #1f2937);
            transform: translateY(-3px);
            box-shadow: 0 6px 15px rgba(75, 85, 99, 0.35);
        }

        .btn:disabled {
            background: #a0aec0;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* --- Slides and Carousel --- */
        .slides-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .slides-container {
            display: flex;
            overflow-x: auto;
            gap: 30px;
            padding: 20px;
            margin: 0 -20px;
            scroll-behavior: smooth;
            min-height: 550px;
            align-items: center;
            scrollbar-width: thin;
            scrollbar-color: #3182ce #e2e8f0;
        }
        
        .slides-container::-webkit-scrollbar { height: 10px; }
        .slides-container::-webkit-scrollbar-track { background: #e2e8f0; border-radius: 10px; }
        .slides-container::-webkit-scrollbar-thumb { background: #3182ce; border-radius: 10px; }
        
        .slide {
            flex: 0 0 400px;
            width: 400px;
            background: white;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.12);
            transition: transform 0.3s, box-shadow 0.3s;
            border: 1px solid #e2e8f0;
            opacity: 0;
            transform: translateY(20px);
            animation: fadeIn 0.5s forwards;
        }
        
        @keyframes fadeIn {
            to { opacity: 1; transform: translateY(0); }
        }
        
        .slide:hover {
            transform: translateY(-10px);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.18);
        }
        
        .slide-header {
            background: #2c5282;
            color: white;
            padding: 15px 20px;
            font-size: 18px;
            display: flex;
            justify-content: space-between;
            font-family: 'Segoe UI', sans-serif;
            font-weight: 600;
        }
        
        .slide-image {
            width: 100%;
            height: 400px;
            background: #f7fafc;
            display: flex;
            align-items: center;
            justify-content: center;
            border-bottom: 1px solid #e2e8f0;
            position: relative;
            text-align: center;
            padding: 20px;
        }
        
        .slide-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: opacity 0.3s;
            padding: 0;
        }
        
        .generation-error {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 15px;
            cursor: pointer;
            color: #c53030;
            border: 2px dashed #e53e3e;
            border-radius: 12px;
            height: 100%;
            width: 100%;
            transition: background-color 0.3s;
        }
        .generation-error:hover {
            background-color: #fed7d7;
        }
        .generation-error i {
            font-size: 3rem;
        }
        .generation-error p {
            font-weight: 600;
            font-size: 1rem;
            line-height: 1.5;
        }

        .slide-text {
            padding: 20px;
            font-size: 16px;
            line-height: 1.7;
            color: #2d3748;
            min-height: 150px;
            background: #f8fafc;
        }

        .placeholder, .loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            color: #718096;
            padding: 30px;
            flex-grow: 1;
        }
        
        .placeholder i { font-size: 70px; margin-bottom: 25px; color: #cbd5e0; opacity: 0.7; }
        .placeholder p { font-size: 18px; max-width: 500px; line-height: 1.6; font-weight: 500; }
        .loading { gap: 25px; padding: 50px; }

        .spinner {
            width: 60px;
            height: 60px;
            border: 6px solid rgba(49, 130, 206, 0.15);
            border-top: 6px solid #3182ce;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin { 100% { transform: rotate(360deg); } }
        
        .slide-controls {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 30px;
        }
        
        .slide-nav {
            background: #3182ce;
            color: white;
            width: 55px;
            height: 55px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 10px rgba(49, 130, 206, 0.3);
        }
        
        .slide-nav:hover {
            background: #2b6cb0;
            transform: scale(1.08);
            box-shadow: 0 6px 15px rgba(49, 130, 206, 0.4);
        }
        
        .slide-nav:disabled {
            background: #a0aec0;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        /* --- Utilities --- */
        .notification {
            position: fixed;
            top: 25px;
            right: 25px;
            padding: 18px 28px;
            border-radius: 10px;
            background: #38a169;
            color: white;
            font-weight: 600;
            box-shadow: 0 6px 18px rgba(0,0,0,0.15);
            transform: translateX(120%);
            transition: transform 0.4s ease;
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 12px;
            font-family: 'Segoe UI', sans-serif;
        }
        
        .notification.show { transform: translateX(0); }
        .notification.error { background: #e53e3e; }
        
        .progress-container {
            width: 100%;
            height: 8px;
            background: #e2e8f0;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 15px;
            display: none;
        }
        
        .progress-bar {
            height: 100%;
            background: linear-gradient(to right, #3182ce, #2b6cb0);
            border-radius: 4px;
            width: 0%;
            transition: width 0.3s ease;
        }
        
        footer {
            text-align: center;
            padding: 30px 0;
            color: #4a5568;
            font-size: 15px;
            border-top: 1px solid #e2e8f0;
            margin-top: 20px;
        }
        
        /* --- Export Dropdown --- */
        .export-dropdown {
            position: relative;
            display: inline-block;
        }

        .export-dropdown .btn {
            background: linear-gradient(to right, #38a169, #2f855a);
        }

        .export-dropdown-content {
            display: none;
            position: absolute;
            background-color: white;
            min-width: 180px;
            box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
            z-index: 1;
            border-radius: 8px;
            overflow: hidden;
            right: 0;
        }

        .export-dropdown-content a {
            color: #2d3748;
            padding: 12px 16px;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 10px;
            font-family: 'Segoe UI', sans-serif;
            font-size: 15px;
        }

        .export-dropdown-content a:hover { background-color: #f1f1f1; }
        .export-dropdown:hover .export-dropdown-content { display: block; }
        .export-dropdown .btn:hover { background: linear-gradient(to right, #2f855a, #276749); }
        
        /* --- History Modal --- */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.6);
            z-index: 1999;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: #fff;
            padding: 25px;
            border-radius: 15px;
            width: 90%;
            max-width: 700px;
            max-height: 80vh;
            display: flex;
            flex-direction: column;
            position: relative;
        }
        
        .modal-content h3 {
            margin: 0 0 20px;
            font-size: 1.5rem;
            color: #2c5282;
            padding-bottom: 10px;
            border-bottom: 1px solid #e2e8f0;
        }

        #history-list {
            list-style: none;
            padding: 0;
            overflow-y: auto;
        }

        .history-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid #e2e8f0;
            transition: background-color 0.2s;
        }
        .history-item:hover { background-color: #f7fafc; }
        
        .history-item-title {
            font-weight: 600;
            color: #4a5568;
            flex-grow: 1;
            margin-right: 15px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .history-item-actions button {
            margin-left: 10px;
            padding: 8px 12px;
            font-size: 14px;
        }

        /* --- Responsive Design --- */
        @media (max-width: 768px) {
            body { padding: 15px; }
            .app-container { gap: 20px; }
            h1 { font-size: 2.2rem; }
            .input-section, .slides-section { padding: 25px; }
            .slide { flex-basis: 340px; width: 340px; }
            .slide-image { height: 340px; }
        }
        
        @media (max-width: 480px) {
            body { padding: 10px; }
            h1 { font-size: 1.8rem; }
            .input-section, .slides-section { padding: 20px; }
            .controls { flex-direction: column; }
            .btn { width: 100%; justify-content: center; }
            .slide { flex-basis: 85vw; width: 85vw; max-width: 320px; }
            .slide-image { height: 85vw; max-height: 320px; }
            .slides-header { justify-content: center; }
        }
        
        /* Universal Modal styles from original code */
        textarea:not(.no-modal-editor){ cursor: pointer; background-color: #f0f8ff; transition: background-color 0.2s; }
        textarea:not(.no-modal-editor):hover { background-color: #e6f2ff; }
        .outline-modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.65); z-index: 2000; justify-content: center; align-items: center; padding: 1rem; box-sizing: border-box; }
        .outline-modal-content { background-color: #fdfdfd; padding: 25px; border-radius: 12px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); width: 90vw; height: 90vh; position: relative; animation: fadeIn 0.3s; display: flex; flex-direction: column; }
        .outline-modal-content h3 { margin-top: 0; margin-bottom: 15px; color: #333; font-size: 1.2em; font-weight: 700; }
        #modal-textarea { width: 100%; box-sizing: border-box; font-size: 1.3em; line-height: 1.6; border: 1px solid #ccc; border-radius: 8px; padding: 10px; flex-grow: 1; min-height: 250px; }
        .outline-modal-content .modal-buttons { text-align: right; margin-top: 15px; }
        .outline-modal-content .preview-close-btn { position: absolute; top: 10px; right: 10px; font-size: 2rem; border: none; background: none; cursor: pointer; }
        .btn-action { display: inline-block; padding: 10px 20px; margin: 5px; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: bold; font-family: 'Noto Serif TC', serif; transition: all 0.3s ease; border: none; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.15); color: white; background-color: #3182ce; }
        .btn-action:hover { transform: translateY(-2px); box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2); filter: brightness(110%); }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>文章幻燈片 Pro</h1>
        </header>
        
        <div class="app-container">
            <div class="input-section">
                <div class="input-header">
                    <i class="fas fa-edit"></i>
                    <h2>輸入文章內容</h2>
                </div>
                
                <div class="input-container">
                    <textarea id="article-input" placeholder="請在此輸入繁體中文文章內容..."></textarea>
                    <div class="char-count">字數: <span id="char-count">0</span></div>
                </div>
                <div class="progress-container" id="progress-container">
                    <div class="progress-bar" id="progress-bar"></div>
                </div>
                <div class="controls">
                    <button id="generate-btn" class="btn btn-primary">
                        <i class="fas fa-magic"></i> 生成幻燈片
                    </button>
                    <button id="save-history-btn" class="btn btn-tertiary">
                        <i class="fas fa-save"></i> 儲存紀錄
                    </button>
                    <button id="history-btn" class="btn btn-tertiary">
                        <i class="fas fa-history"></i> 查看紀錄
                    </button>
                    <button id="reset-btn" class="btn btn-secondary">
                        <i class="fas fa-redo"></i> 重置內容
                    </button>
                </div>
            </div>
            
            <div class="slides-section">
                <div class="slides-header">
                    <div class="input-header">
                        <i class="fas fa-images"></i>
                        <h2>幻燈片展示</h2>
                    </div>
                    <div class="export-dropdown">
                        <button id="export-btn" class="btn" disabled>
                            <i class="fas fa-download"></i> 匯出
                        </button>
                        <div class="export-dropdown-content">
                            <a href="#" id="export-pdf"><i class="fas fa-file-pdf"></i> 匯出為 PDF</a>
                            <a href="#" id="export-html"><i class="fas fa-file-code"></i> 匯出為 HTML</a>
                            <a href="#" id="export-word"><i class="fas fa-file-word"></i> 匯出為 Word</a>
                        </div>
                    </div>
                </div>
                
                <div class="slides-container" id="slides-container">
                    <div class="placeholder">
                        <i class="fas fa-scroll"></i>
                        <p>輸入文章並點擊「生成幻燈片」按鈕後，這裡將顯示帶有AI生成插圖的幻燈片</p>
                    </div>
                </div>
                
                <div class="slide-controls">
                    <div class="slide-nav" id="prev-slide" title="上一張">
                        <i class="fas fa-chevron-left"></i>
                    </div>
                    <div class="slide-nav" id="next-slide" title="下一張">
                        <i class="fas fa-chevron-right"></i>
                    </div>
                </div>
            </div>
        </div>
        
        <footer>
            <p>© 2025 陳冠健</p>
        </footer>
    </div>
    
    <div class="notification" id="notification"></div>
    
    <!-- History Modal -->
    <div id="history-modal" class="modal-overlay">
        <div class="modal-content">
            <h3>歷史紀錄</h3>
            <ul id="history-list"></ul>
            <button id="history-close-btn" class="preview-close-btn" title="關閉" style="color: #333;">&times;</button>
        </div>
    </div>

    <!-- Original Outline Editor Modal -->
    <div id="outline-editor-modal" class="outline-modal-overlay">
        <div class="outline-modal-content">
            <h3 id="modal-title">編輯內容</h3>
            <textarea id="modal-textarea" rows="15"></textarea>
            <div class="modal-buttons">
                <button id="modal-ocr-btn" class="btn-action" style="background-color: #17a2b8;">OCR</button>
                <button id="modal-save-btn" class="btn-action">輸入</button>
            </div>
            <button id="modal-close-btn" class="preview-close-btn" title="關閉">&times;</button>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // --- DOM Element Selection ---
            const articleInput = document.getElementById('article-input');
            const charCount = document.getElementById('char-count');
            const generateBtn = document.getElementById('generate-btn');
            const resetBtn = document.getElementById('reset-btn');
            const slidesContainer = document.getElementById('slides-container');
            const prevSlideBtn = document.getElementById('prev-slide');
            const nextSlideBtn = document.getElementById('next-slide');
            const notification = document.getElementById('notification');
            const progressContainer = document.getElementById('progress-container');
            const progressBar = document.getElementById('progress-bar');
            
            // New Feature Elements
            const saveHistoryBtn = document.getElementById('save-history-btn');
            const historyBtn = document.getElementById('history-btn');
            const historyModal = document.getElementById('history-modal');
            const historyList = document.getElementById('history-list');
            const historyCloseBtn = document.getElementById('history-close-btn');
            const exportBtn = document.getElementById('export-btn');
            const exportPdfBtn = document.getElementById('export-pdf');
            const exportHtmlBtn = document.getElementById('export-html');
            const exportWordBtn = document.getElementById('export-word');

            // --- Constants ---
            const LS_SESSION_KEY = 'articleSlideshow_currentSession';
            const LS_HISTORY_KEY = 'articleSlideshow_history';
            const MAX_RETRIES = 3;
            const IMAGE_GEN_BATCH_SIZE = 4; // Process 4 images at a time

            // =======================================================
            // ===             CORE HELPER FUNCTIONS               ===
            // =======================================================

            function showNotification(message, isError = false) {
                const icon = isError ? 'fas fa-exclamation-circle' : 'fas fa-check-circle';
                notification.innerHTML = `<i class="${icon}"></i> <span>${message}</span>`;
                notification.className = 'notification';
                if (isError) notification.classList.add('error');
                notification.classList.add('show');
                setTimeout(() => notification.classList.remove('show'), 3500);
            }

            function debounce(func, delay) {
                let timeout;
                return function(...args) {
                    clearTimeout(timeout);
                    timeout = setTimeout(() => func.apply(this, args), delay);
                };
            }
            
            // =======================================================
            // ===        SESSION & LOCAL STORAGE MANAGEMENT       ===
            // =======================================================

            function saveCurrentSession(data) {
                try {
                    localStorage.setItem(LS_SESSION_KEY, JSON.stringify(data));
                } catch (e) {
                    console.error("Error saving session to localStorage:", e);
                    showNotification("無法儲存當前進度", true);
                }
            }

            function loadSessionFromLocalStorage() {
                const savedSession = localStorage.getItem(LS_SESSION_KEY);
                if (savedSession) {
                    try {
                        const data = JSON.parse(savedSession);
                        articleInput.value = data.articleText || '';
                        articleInput.dispatchEvent(new Event('input')); // Update char count
                        
                        if (data.slides && data.slides.length > 0) {
                            renderSlidesFromData(data.slides);
                            showNotification("已成功載入您上次的進度！");
                        }
                    } catch (e) {
                        console.error("Error loading session:", e);
                        localStorage.removeItem(LS_SESSION_KEY);
                    }
                }
            }
            
            const debouncedSaveText = debounce((text) => {
                const session = JSON.parse(localStorage.getItem(LS_SESSION_KEY) || '{}');
                session.articleText = text;
                saveCurrentSession(session);
            }, 500);

            articleInput.addEventListener('input', () => {
                charCount.textContent = articleInput.value.length;
                debouncedSaveText(articleInput.value);
            });
            
            function renderSlidesFromData(slidesData) {
                slidesContainer.innerHTML = '';
                if (!slidesData || slidesData.length === 0) {
                    slidesContainer.innerHTML = `<div class="placeholder"><i class="fas fa-scroll"></i><p>這裡將顯示生成的幻燈片</p></div>`;
                    prevSlideBtn.disabled = true;
                    nextSlideBtn.disabled = true;
                    exportBtn.disabled = true;
                    return;
                }

                slidesData.forEach((slideData, index) => {
                    const slideElement = document.createElement('div');
                    slideElement.className = 'slide';
                    slideElement.dataset.paragraph = slideData.paragraph;

                    let imageContent = '';
                    if (slideData.status === 'success' && slideData.imageUrl) {
                        imageContent = `<img src="${slideData.imageUrl}" alt="幻燈片 ${index + 1} 插圖" style="cursor: pointer;" title="點擊以重新生成此圖片">`;
                    } else if (slideData.status === 'error') {
                        imageContent = `<div class="generation-error" data-action="retry-generation" title="點擊以重新生成此圖片"><i class="fas fa-image-slash"></i><p>圖片生成失敗。<br>請點擊此處重試。</p></div>`;
                    } else {
                        imageContent = `<div class="loading"><div class="spinner"></div></div>`;
                    }

                    slideElement.innerHTML = `
                        <div class="slide-header">
                            <span>幻燈片 ${index + 1}/${slidesData.length}</span>
                            <span>${slideData.paragraph.length} 字</span>
                        </div>
                        <div class="slide-image">${imageContent}</div>
                        <div class="slide-text"><p>${slideData.paragraph}</p></div>
                    `;
                    slidesContainer.appendChild(slideElement);
                });

                prevSlideBtn.disabled = false;
                nextSlideBtn.disabled = false;
                exportBtn.disabled = false;
            }

            // =======================================================
            // ===                 RESET FUNCTION                  ===
            // =======================================================
            
            resetBtn.addEventListener('click', function() {
                if (!confirm("您確定要重置所有內容嗎？目前進度將會遺失。")) return;

                articleInput.value = '';
                articleInput.dispatchEvent(new Event('input'));
                slidesContainer.innerHTML = `
                    <div class="placeholder">
                        <i class="fas fa-scroll"></i>
                        <p>輸入文章並點擊「生成幻燈片」按鈕後，這裡將顯示帶有AI生成插圖的幻燈片</p>
                    </div>
                `;
                prevSlideBtn.disabled = true;
                nextSlideBtn.disabled = true;
                exportBtn.disabled = true;
                progressContainer.style.display = 'none';
                progressBar.style.width = '0%';
                
                localStorage.removeItem(LS_SESSION_KEY);
                showNotification('已重置所有內容！');
            });

            // =======================================================
            // ===              HISTORY MANAGEMENT                 ===
            // =======================================================

            saveHistoryBtn.addEventListener('click', () => {
                const sessionRaw = localStorage.getItem(LS_SESSION_KEY);
                if (!sessionRaw) {
                    showNotification("沒有可儲存的內容", true);
                    return;
                }
                const session = JSON.parse(sessionRaw);
                if (!session.slides || session.slides.length === 0) {
                    showNotification("請先生成幻燈片再儲存", true);
                    return;
                }

                const history = JSON.parse(localStorage.getItem(LS_HISTORY_KEY) || '[]');
                const newEntry = {
                    id: Date.now(),
                    title: session.articleText.substring(0, 40) + '...',
                    articleText: session.articleText,
                    slides: session.slides,
                    savedAt: new Date().toISOString()
                };
                history.unshift(newEntry); // Add to the top
                localStorage.setItem(LS_HISTORY_KEY, JSON.stringify(history));
                showNotification("成功儲存至歷史紀錄！");
            });

            historyBtn.addEventListener('click', () => {
                renderHistoryList();
                historyModal.style.display = 'flex';
            });

            historyCloseBtn.addEventListener('click', () => {
                historyModal.style.display = 'none';
            });

            function renderHistoryList() {
                const history = JSON.parse(localStorage.getItem(LS_HISTORY_KEY) || '[]');
                historyList.innerHTML = '';
                if (history.length === 0) {
                    historyList.innerHTML = '<p>尚無歷史紀錄。</p>';
                    return;
                }
                history.forEach(item => {
                    const li = document.createElement('li');
                    li.className = 'history-item';
                    li.innerHTML = `
                        <span class="history-item-title" title="${item.title}">${item.title}</span>
                        <div class="history-item-actions">
                            <button class="btn btn-primary btn-sm" data-id="${item.id}" data-action="load">載入</button>
                            <button class="btn btn-secondary btn-sm" data-id="${item.id}" data-action="delete">刪除</button>
                        </div>
                    `;
                    historyList.appendChild(li);
                });
            }

            historyList.addEventListener('click', (e) => {
                const target = e.target;
                const action = target.dataset.action;
                const id = parseInt(target.dataset.id);
                if (!action || !id) return;

                let history = JSON.parse(localStorage.getItem(LS_HISTORY_KEY) || '[]');
                
                if (action === 'load') {
                    if (confirm("載入此紀錄將會覆蓋您目前的進度，確定要繼續嗎？")) {
                        const itemToLoad = history.find(item => item.id === id);
                        if (itemToLoad) {
                            saveCurrentSession(itemToLoad);
                            loadSessionFromLocalStorage();
                            historyModal.style.display = 'none';
                        }
                    }
                } else if (action === 'delete') {
                     if (confirm("您確定要永久刪除此項紀錄嗎？")) {
                        history = history.filter(item => item.id !== id);
                        localStorage.setItem(LS_HISTORY_KEY, JSON.stringify(history));
                        renderHistoryList();
                        showNotification("紀錄已刪除");
                    }
                }
            });

            // =======================================================
            // ===               EXPORT FUNCTIONS                  ===
            // =======================================================
            
            async function convertImgToBase64(url) {
                const response = await fetch(url);
                const blob = await response.blob();
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onloadend = () => resolve(reader.result);
                    reader.onerror = reject;
                    reader.readAsDataURL(blob);
                });
            }

            exportPdfBtn.addEventListener('click', async (e) => {
                e.preventDefault();
                showNotification("正在準備 PDF，請稍候...");
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF({ orientation: 'p', unit: 'px', format: 'a4' });
                const slideElements = slidesContainer.querySelectorAll('.slide');
                
                for (let i = 0; i < slideElements.length; i++) {
                    const canvas = await html2canvas(slideElements[i]);
                    const imgData = canvas.toDataURL('image/png');
                    const pageWidth = doc.internal.pageSize.getWidth();
                    const pageHeight = doc.internal.pageSize.getHeight();
                    const imgWidth = canvas.width;
                    const imgHeight = canvas.height;
                    const ratio = Math.min(pageWidth / imgWidth, pageHeight / imgHeight);
                    const finalWidth = imgWidth * ratio * 0.9; // 90% margin
                    const finalHeight = imgHeight * ratio * 0.9;
                    const x = (pageWidth - finalWidth) / 2;
                    const y = (pageHeight - finalHeight) / 2;

                    if (i > 0) doc.addPage();
                    doc.addImage(imgData, 'PNG', x, y, finalWidth, finalHeight);
                }
                doc.save('slideshow.pdf');
                showNotification("PDF 匯出完成！");
            });

            exportHtmlBtn.addEventListener('click', async (e) => {
                e.preventDefault();
                showNotification("正在準備 HTML 檔案...");
                const session = JSON.parse(localStorage.getItem(LS_SESSION_KEY) || '{}');
                if (!session.slides) return;

                let slidesHtml = '';
                for (const slide of session.slides) {
                    let imageSrc = 'https://via.placeholder.com/400?text=Image+Error';
                    if(slide.imageUrl) {
                        try {
                           imageSrc = await convertImgToBase64(slide.imageUrl);
                        } catch (err) { console.error(err); }
                    }
                    slidesHtml += `
                        <div class="slide">
                            <img src="${imageSrc}" alt="Slide image">
                            <p>${slide.paragraph}</p>
                        </div>
                    `;
                }

                const htmlContent = `
                    <!DOCTYPE html><html lang="zh-TW"><head><meta charset="UTF-8"><title>Slideshow Export</title>
                    <style>body{font-family: sans-serif; margin: 20px;} .slide{border: 1px solid #ccc; border-radius: 8px; margin-bottom: 20px; padding: 15px; max-width: 600px;} img{max-width: 100%; height: auto; border-radius: 4px;} p{line-height: 1.6;}</style></head>
                    <body><h1>${session.articleText.substring(0, 50)}...</h1>${slidesHtml}</body></html>
                `;
                
                const blob = new Blob([htmlContent], {type: 'text/html'});
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = 'slideshow.html';
                link.click();
                URL.revokeObjectURL(link.href);
                showNotification("HTML 匯出完成！");
            });

            exportWordBtn.addEventListener('click', async (e) => {
                e.preventDefault();
                showNotification("正在準備 Word 檔案...");
                const session = JSON.parse(localStorage.getItem(LS_SESSION_KEY) || '{}');
                if (!session.slides) return;
                
                const children = [];
                for (const slide of session.slides) {
                    if (slide.imageUrl) {
                        try {
                            const response = await fetch(slide.imageUrl);
                            const imageBuffer = await response.blob();
                            children.push(new docx.ImageRun({
                                data: imageBuffer,
                                transformation: { width: 400, height: 400 },
                            }));
                        } catch (err) { console.error('Image fetch for docx failed:', err); }
                    }
                    children.push(new docx.Paragraph({ text: slide.paragraph, style: "normalPara" }));
                    children.push(new docx.Paragraph({ text: "", style: "normalPara" })); // Spacer
                }
                
                const doc = new docx.Document({
                    sections: [{ properties: {}, children }],
                    styles: { paragraphStyles: [{ id: "normalPara", name: "Normal Para", run: { size: 24 } }] }
                });

                docx.Packer.toBlob(doc).then(blob => {
                    const link = document.createElement('a');
                    link.href = URL.createObjectURL(blob);
                    link.download = 'slideshow.docx';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    showNotification("Word 匯出完成！");
                });
            });

            // =======================================================
            // ===            MAIN GENERATION LOGIC                ===
            // =======================================================

            function splitArticleIntoParagraphs(article) {
                const sentences = article.split(/(?<=[。！？；])/g);
                const paragraphs = [];
                let currentParagraph = '';
                sentences.forEach(sentence => {
                    if ((currentParagraph + sentence).length <= 100) {
                        currentParagraph += sentence;
                    } else {
                        if (currentParagraph.trim()) paragraphs.push(currentParagraph.trim());
                        currentParagraph = sentence;
                    }
                });
                if (currentParagraph.trim()) paragraphs.push(currentParagraph.trim());
                return paragraphs.filter(p => p.trim() !== '');
            }

            async function translateToEnglish(text) {
                const myEmail = 'kenchan20151@gmail.com';
                const apiUrl = `https://api.mymemory.translated.net/get?q=${encodeURIComponent(text)}&langpair=zh-TW|en&de=${myEmail}`;
                try {
                    const response = await fetch(apiUrl);
                    if (!response.ok) throw new Error(`API status ${response.status}`);
                    const data = await response.json();
                    if (data.responseStatus !== 200) throw new Error(data.responseDetails);
                    return data.responseData.translatedText;
                } catch (error) {
                    console.error('Translation error:', error);
                    return null;
                }
            }
            
            function generateImagePrompt(englishParagraph) {
                return `Illustration of: "${englishParagraph}". Rendered in a classic manga style with an emphasis on simplicity. Use only black and white, with clean, uniform, and minimalist line art. The overall feel should be a high-contrast, clear monochrome comic panel or sketch. No text is included`;
            }

            async function generateImageWithRetries(prompt, baseSeed, attempt = 1) {
                if (attempt > MAX_RETRIES) throw new Error(`已達最大重試次數 (${MAX_RETRIES})`);
                
                const imageUrl = `https://image.pollinations.ai/prompt/${encodeURIComponent(prompt)}?token=Jeq-UCxbpvrqUEzN&model=flux&enhance=false&private=true&nologo=true&seed=${baseSeed + attempt}`;
                
                try {
                    const response = await fetch(imageUrl);
                    if (!response.ok || !response.headers.get('content-type')?.startsWith('image')) {
                        throw new Error(`Invalid image response (status: ${response.status})`);
                    }
                    // The URL itself is what we need if successful
                    return imageUrl;
                } catch (error) {
                    console.warn(`Attempt ${attempt} failed for seed ${baseSeed}. Retrying...`, error);
                    await new Promise(res => setTimeout(res, 1000 * attempt)); // wait longer each time
                    return generateImageWithRetries(prompt, baseSeed, attempt + 1);
                }
            }

            generateBtn.addEventListener('click', async function() {
                const article = articleInput.value.trim();
                if (!article) {
                    showNotification('請輸入文章內容！', true);
                    return;
                }
                
                generateBtn.disabled = true;
                resetBtn.disabled = true;

                const paragraphs = splitArticleIntoParagraphs(article);
                let slidesData = paragraphs.map(p => ({ paragraph: p, imageUrl: null, status: 'pending' }));
                
                // 1. Initial UI setup
                renderSlidesFromData(slidesData);
                slidesContainer.innerHTML = ''; // Clear for new elements
                progressContainer.style.display = 'block';
                progressBar.style.width = '0%';
                
                const slideElements = [];
                slidesData.forEach((data, i) => {
                    const slideElement = document.createElement('div');
                    slideElement.className = 'slide';
                    slideElement.dataset.paragraph = data.paragraph;
                    slideElement.innerHTML = `
                        <div class="slide-header"><span>幻燈片 ${i+1}/${slidesData.length}</span><span>${data.paragraph.length} 字</span></div>
                        <div class="slide-image"><div class="loading"><div class="spinner"></div><p>等待處理...</p></div></div>
                        <div class="slide-text"><p>${data.paragraph}</p></div>`;
                    slidesContainer.appendChild(slideElement);
                    slideElements.push(slideElement);
                });

                // 2. Main Generation Process
                let completedCount = 0;
                
                async function processParagraph(para, index) {
                    const slideElement = slideElements[index];
                    const imageContainer = slideElement.querySelector('.slide-image');
                    const loadingText = imageContainer.querySelector('p');
                    const baseSeed = Math.floor(Math.random() * 1000000);

                    try {
                        if (loadingText) loadingText.textContent = '翻譯中...';
                        const englishPara = await translateToEnglish(para);
                        if (!englishPara) throw new Error('翻譯失敗');

                        if (loadingText) loadingText.textContent = '生成圖片...';
                        const prompt = generateImagePrompt(englishPara);
                        const imageUrl = await generateImageWithRetries(prompt, baseSeed);

                        slidesData[index].imageUrl = imageUrl;
                        slidesData[index].status = 'success';
                        imageContainer.innerHTML = `<img src="${imageUrl}" alt="幻燈片 ${index + 1} 插圖" style="cursor: pointer;" title="點擊以重新生成此圖片">`;

                    } catch (error) {
                        console.error(`Slide ${index + 1} failed:`, error);
                        slidesData[index].status = 'error';
                        imageContainer.innerHTML = `<div class="generation-error" data-action="retry-generation" title="點擊以重新生成此圖片"><i class="fas fa-sync-alt"></i><p>${error.message}<br>點擊重試</p></div>`;
                    } finally {
                        completedCount++;
                        progressBar.style.width = `${(completedCount / paragraphs.length) * 100}%`;
                    }
                }
                
                // 3. Run in throttled parallel batches
                for (let i = 0; i < paragraphs.length; i += IMAGE_GEN_BATCH_SIZE) {
                    const batch = paragraphs.slice(i, i + IMAGE_GEN_BATCH_SIZE);
                    const batchPromises = batch.map((p, j) => processParagraph(p, i + j));
                    await Promise.all(batchPromises);
                }

                // 4. Finalize
                saveCurrentSession({ articleText: article, slides: slidesData });
                showNotification('幻燈片生成完成！');
                generateBtn.disabled = false;
                resetBtn.disabled = false;
                exportBtn.disabled = false;
            });
            
            async function regenerateImageForSlide(slideElement) {
                // This is the existing single-regeneration logic, kept for manual retries
                 const imageContainer = slideElement.querySelector('.slide-image');
                const originalParagraph = slideElement.dataset.paragraph;

                if (!originalParagraph) {
                    showNotification('找不到原始文本，無法重新生成。', true);
                    return;
                }

                imageContainer.innerHTML = `
                    <div class="loading" style="padding: 20px;">
                        <div class="spinner" style="width: 40px; height: 40px; border-width: 4px;"></div>
                        <p style="font-size: 14px; margin-top: 10px;">翻譯並生成新圖片中...</p>
                    </div>`;

                try {
                    const englishPara = await translateToEnglish(originalParagraph);
                    if (!englishPara) throw new Error('翻譯失敗');

                    const prompt = generateImagePrompt(englishPara);
                    const newSeed = Math.floor(Math.random() * 10000000);
                    const imageUrl = await generateImageWithRetries(prompt, newSeed);

                    imageContainer.innerHTML = '';
                    const img = new Image();
                    img.src = imageUrl;
                    img.alt = '重新生成的插圖';
                    img.style.cursor = 'pointer';
                    img.title = '點擊以重新生成此圖片';
                    imageContainer.appendChild(img);

                    // Update localStorage
                    const session = JSON.parse(localStorage.getItem(LS_SESSION_KEY) || '{}');
                    const slideIndex = Array.from(slidesContainer.children).indexOf(slideElement);
                    if (session.slides && session.slides[slideIndex]) {
                        session.slides[slideIndex].imageUrl = imageUrl;
                        session.slides[slideIndex].status = 'success';
                        saveCurrentSession(session);
                    }
                    
                    showNotification('圖片已成功重新生成！');
                } catch (error) {
                    imageContainer.innerHTML = `
                        <div class="generation-error" data-action="retry-generation" title="點擊以重新生成此圖片">
                            <i class="fas fa-sync-alt"></i><p>重新生成失敗: ${error.message}<br>請點擊此處重試。</p>
                        </div>`;
                    showNotification(`重新生成失敗：${error.message}`, true);
                }
            }
            
            slidesContainer.addEventListener('click', async function(event) {
                const retryTarget = event.target.closest('[data-action="retry-generation"]');
                const imageTarget = event.target.tagName === 'IMG' ? event.target : null;
                if (retryTarget || imageTarget) {
                    const slideElement = event.target.closest('.slide');
                    if (slideElement && confirm('您確定要重新生成這張插圖嗎？')) {
                        await regenerateImageForSlide(slideElement);
                    }
                }
            });

            // =======================================================
            // ===          SLIDE NAVIGATION & INIT                ===
            // =======================================================
            
            prevSlideBtn.addEventListener('click', () => {
                const slideWidth = slidesContainer.querySelector('.slide')?.offsetWidth || 0;
                slidesContainer.scrollBy({ left: -(slideWidth + 30), behavior: 'smooth' });
            });
            
            nextSlideBtn.addEventListener('click', () => {
                const slideWidth = slidesContainer.querySelector('.slide')?.offsetWidth || 0;
                slidesContainer.scrollBy({ left: slideWidth + 30, behavior: 'smooth' });
            });
            
            // --- Initial Load ---
            loadSessionFromLocalStorage();
        });

        // =======================================================
        // ===        ORIGINAL MODAL EDITOR SCRIPT (KEPT)        ===
        // =======================================================
        document.addEventListener('DOMContentLoaded', () => {
            const modal = document.getElementById('outline-editor-modal');
            const modalTextarea = document.getElementById('modal-textarea');
            const modalTitle = document.getElementById('modal-title');
            const modalSaveBtn = document.getElementById('modal-save-btn');
            const modalCloseBtn = document.getElementById('modal-close-btn');
            const ocrBtn = document.getElementById('modal-ocr-btn');
            if(!modal) return;
            let currentEditingElement = null;
            function openModalEditor(element) {
                currentEditingElement = element;
                modalTextarea.value = currentEditingElement.value;
                if (element.id === 'article-input') { modalTitle.textContent = '輸入文章內容'; } 
                else { modalTitle.textContent = '編輯內容'; }
                modal.style.display = 'flex'; modalTextarea.focus();
            }
            function closeModalEditor() { modal.style.display = 'none'; currentEditingElement = null; }
            function saveAndCloseEditor() {
                if (currentEditingElement) {
                    currentEditingElement.value = modalTextarea.value;
                    currentEditingElement.dispatchEvent(new Event('input', { bubbles: true }));
                }
                closeModalEditor();
            }
            document.body.addEventListener('click', (event) => {
                if (event.target.id === 'article-input' && event.target.tagName === 'TEXTAREA') {
                    event.preventDefault(); openModalEditor(event.target);
                }
            });
            modalSaveBtn.addEventListener('click', saveAndCloseEditor);
            modalCloseBtn.addEventListener('click', closeModalEditor);
            modal.addEventListener('click', (event) => { if (event.target === modal) closeModalEditor(); });
            let ocrWindow = null;
            const VERCEL_OCR_URL = 'https://gemini-ocr-proxy.vercel.app/';
            ocrBtn.addEventListener('click', () => {
                if (ocrWindow && !ocrWindow.closed) { ocrWindow.focus(); return; }
                ocrWindow = window.open(VERCEL_OCR_URL, 'OCRWindow', 'width=650,height=850,scrollbars=yes,resizable=yes');
            });
            window.addEventListener('message', (event) => {
                if (event.origin !== new URL(VERCEL_OCR_URL).origin) return;
                if (event.data && event.data.type === 'ocrResult') {
                    modalTextarea.value += (modalTextarea.value.trim() ? '\n' : '') + event.data.text;
                    if (ocrWindow) ocrWindow.close();
                    modalTextarea.focus();
                }
            });
        });
    </script>
</body>
</html>