<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>文章幻燈片 Pro v2.2 (智能版)</title>

    <!-- Google Fonts: Noto Serif TC -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;700&family=Segoe+UI:wght@400;600;700&display=swap" rel="stylesheet">
    
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            --primary-color: #3182ce; --primary-dark: #2b6cb0; --secondary-color: #e53e3e; --tertiary-color: #6b7280;
            --text-dark: #2d3748; --text-light: #4a5568; --bg-light: #f0f4f8; --bg-gradient: linear-gradient(135deg, #f0f4f8 0%, #d9e2ec 100%);
            --white: #ffffff; --border-color: #e2e8f0;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Noto Serif TC', serif; background: var(--bg-gradient); min-height: 100vh; padding: 20px; color: var(--text-dark); overflow-x: hidden; }
        .container { max-width: 1200px; margin: 0 auto; }
        header { text-align: center; padding: 40px 0 20px; margin-bottom: 20px; }
        h1 { font-size: 2.8rem; font-weight: 700; color: #2c5282; margin-bottom: 15px; text-shadow: 2px 2px 4px rgba(0,0,0,0.1); background: linear-gradient(to right, #2c5282, #4a5568); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        h2 { font-size: 1.8rem; font-weight: 700; color: #2c5282; }
        .app-container { display: flex; flex-direction: column; gap: 30px; background: var(--white); border-radius: 20px; box-shadow: 0 15px 40px rgba(0, 0, 0, 0.15); overflow: hidden; margin-bottom: 40px; }
        .input-section, .slides-section { padding: 30px; }
        .input-section { background: #f8fafc; border-bottom: 1px solid var(--border-color); }
        .input-header { display: flex; align-items: center; margin-bottom: 20px; gap: 15px; }
        .input-header i { font-size: 28px; color: var(--primary-color); }
        textarea { width: 100%; height: 200px; padding: 20px; border: 2px solid #cbd5e0; border-radius: 12px; font-size: 16px; line-height: 1.6; resize: vertical; transition: all 0.3s; background: var(--white); font-family: 'Noto Serif TC', serif; }
        textarea:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 0 0 4px rgba(66, 153, 225, 0.2); }
        .char-count { text-align: right; color: var(--text-light); font-size: 14px; font-weight: 500; font-family: 'Segoe UI', sans-serif; }
        .controls { display: flex; flex-wrap: wrap; justify-content: center; gap: 15px; margin-top: 20px; }
        .btn { padding: 14px 25px; border: none; border-radius: 50px; font-size: 16px; cursor: pointer; transition: all 0.3s ease; display: flex; align-items: center; gap: 10px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); font-family: 'Segoe UI', sans-serif; font-weight: 600; flex-shrink: 0; }
        .btn-primary { background: linear-gradient(to right, var(--primary-color), var(--primary-dark)); color: var(--white); }
        .btn-primary:hover { background: linear-gradient(to right, var(--primary-dark), #2c5282); transform: translateY(-3px); box-shadow: 0 6px 15px rgba(43, 108, 176, 0.35); }
        .btn-secondary { background: linear-gradient(to right, var(--secondary-color), #c53030); color: var(--white); }
        .btn-secondary:hover { background: linear-gradient(to right, #c53030, #9b2c2c); transform: translateY(-3px); box-shadow: 0 6px 15px rgba(197, 48, 48, 0.35); }
        .btn-tertiary { background: linear-gradient(to right, var(--tertiary-color), #4b5563); color: var(--white); }
        .btn-tertiary:hover { background: linear-gradient(to right, #4b5563, #1f2937); transform: translateY(-3px); box-shadow: 0 6px 15px rgba(75, 85, 99, 0.35); }
        .btn-export { background: linear-gradient(to right, #38a169, #2f855a); color: var(--white); }
        .btn-export:hover { background: linear-gradient(to right, #2f855a, #276749); transform: translateY(-3px); box-shadow: 0 6px 15px rgba(47, 133, 90, 0.35); }
        .btn:disabled { background: #a0aec0; cursor: not-allowed; transform: none; box-shadow: none; }
        .slides-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; flex-wrap: wrap; gap: 15px; }
        .slides-container { display: flex; overflow-x: auto; gap: 30px; padding: 20px; margin: 0 -20px; scroll-behavior: smooth; min-height: 550px; align-items: center; scrollbar-width: thin; scrollbar-color: var(--primary-color) var(--border-color); }
        .slides-container::-webkit-scrollbar { height: 10px; }
        .slides-container::-webkit-scrollbar-track { background: var(--border-color); border-radius: 10px; }
        .slides-container::-webkit-scrollbar-thumb { background: var(--primary-color); border-radius: 10px; }
        .slide { flex: 0 0 400px; width: 400px; background: var(--white); border-radius: 16px; overflow: hidden; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.12); transition: transform 0.3s, box-shadow 0.3s; border: 1px solid var(--border-color); opacity: 0; transform: translateY(20px); animation: fadeIn 0.5s forwards; }
        @keyframes fadeIn { to { opacity: 1; transform: translateY(0); } }
        .slide:hover { transform: translateY(-10px); box-shadow: 0 15px 35px rgba(0, 0, 0, 0.18); }
        .slide-header { background: #2c5282; color: var(--white); padding: 15px 20px; font-size: 18px; display: flex; justify-content: space-between; font-family: 'Segoe UI', sans-serif; font-weight: 600; }
        .slide-image { width: 100%; height: 400px; background: #f7fafc; display: flex; align-items: center; justify-content: center; border-bottom: 1px solid var(--border-color); position: relative; text-align: center; padding: 20px; }
        .slide-image img { width: 100%; height: 100%; object-fit: cover; transition: opacity 0.3s; padding: 0; }
        .generation-error { display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 15px; cursor: pointer; color: #c53030; border: 2px dashed #e53e3e; border-radius: 12px; height: 100%; width: 100%; transition: background-color 0.3s; }
        .generation-error:hover { background-color: #fed7d7; }
        .generation-error i { font-size: 3rem; }
        .generation-error p { font-weight: 600; font-size: 1rem; line-height: 1.5; }
        .slide-text { padding: 20px; font-size: 16px; line-height: 1.7; color: var(--text-dark); min-height: 150px; background: #f8fafc; }
        .placeholder, .loading { display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; color: var(--text-light); padding: 30px; flex-grow: 1; }
        .placeholder i { font-size: 70px; margin-bottom: 25px; color: #cbd5e0; opacity: 0.7; }
        .placeholder p { font-size: 18px; max-width: 500px; line-height: 1.6; font-weight: 500; }
        .loading { gap: 25px; padding: 50px; }
        .spinner { width: 60px; height: 60px; border: 6px solid rgba(49, 130, 206, 0.15); border-top: 6px solid var(--primary-color); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 100% { transform: rotate(360deg); } }
        .slide-controls-wrapper { display: flex; flex-direction: column; align-items: center; gap: 20px; margin-top: 30px; }
        .slide-controls { display: flex; justify-content: center; gap: 20px; }
        .slide-nav { background: var(--primary-color); color: var(--white); width: 55px; height: 55px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.3s; box-shadow: 0 4px 10px rgba(49, 130, 206, 0.3); }
        .slide-nav:hover { background: var(--primary-dark); transform: scale(1.08); box-shadow: 0 6px 15px rgba(49, 130, 206, 0.4); }
        .slide-nav:disabled { background: #a0aec0; cursor: not-allowed; transform: none; box-shadow: none; }
        #chapter-nav { display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; padding: 10px 0; }
        .chapter-btn { padding: 8px 16px; font-family: 'Segoe UI', sans-serif; font-size: 14px; border: 1px solid #cbd5e0; background-color: var(--white); border-radius: 20px; cursor: pointer; transition: all 0.2s; }
        .chapter-btn:hover { background-color: #edf2f7; border-color: var(--primary-color); }
        .chapter-btn.active { background-color: var(--primary-color); color: var(--white); border-color: var(--primary-color); font-weight: 600; }
        .notification { position: fixed; top: 25px; right: 25px; padding: 18px 28px; border-radius: 10px; background: #38a169; color: var(--white); font-weight: 600; box-shadow: 0 6px 18px rgba(0,0,0,0.15); transform: translateX(120%); transition: transform 0.4s ease; z-index: 2100; display: flex; align-items: center; gap: 12px; font-family: 'Segoe UI', sans-serif; }
        .notification.show { transform: translateX(0); }
        .notification.error { background: var(--secondary-color); }
        .progress-container { width: 100%; height: 8px; background: var(--border-color); border-radius: 4px; overflow: hidden; margin-top: 15px; display: none; }
        .progress-bar { height: 100%; background: linear-gradient(to right, var(--primary-color), var(--primary-dark)); border-radius: 4px; width: 0%; transition: width 0.3s ease; }
        footer { text-align: center; padding: 30px 0; color: var(--text-light); font-size: 15px; border-top: 1px solid var(--border-color); margin-top: 20px; }
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 1999; justify-content: center; align-items: center; }
        .modal-content { background: var(--white); padding: 25px; border-radius: 15px; width: 90%; max-width: 700px; max-height: 80vh; display: flex; flex-direction: column; position: relative; }
        .modal-content h3 { margin: 0 0 20px; font-size: 1.5rem; color: #2c5282; padding-bottom: 10px; border-bottom: 1px solid var(--border-color); }
        #history-list { list-style: none; padding: 0; overflow-y: auto; }
        .history-item { display: flex; justify-content: space-between; align-items: center; padding: 15px; border-bottom: 1px solid var(--border-color); transition: background-color 0.2s; }
        .history-item:hover { background-color: #f7fafc; }
        .history-item-title { font-weight: 600; color: var(--text-light); flex-grow: 1; margin-right: 15px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .history-item-actions { display: flex; gap: 10px; }
        .history-icon-btn { background: none; border: none; cursor: pointer; padding: 5px; border-radius: 50%; display: flex; align-items: center; justify-content: center; transition: background-color 0.2s; }
        .history-icon-btn:hover { background-color: #e2e8f0; }
        .history-icon-btn svg { width: 20px; height: 20px; fill: var(--text-light); transition: fill 0.2s; }
        .history-icon-btn:hover svg { fill: var(--text-dark); }
        @media (max-width: 768px) { body { padding: 15px; } h1 { font-size: 2.2rem; } .slide { flex-basis: 340px; width: 340px; } .slide-image { height: 340px; } }
        @media (max-width: 480px) { body { padding: 10px; } h1 { font-size: 1.8rem; } .controls { flex-direction: column; } .btn { width: 100%; justify-content: center; } .slide { flex-basis: 85vw; width: 85vw; max-width: 320px; } .slide-image { height: 85vw; max-height: 320px; } .slides-header { justify-content: center; } }
        textarea:not(.no-modal-editor){ cursor: pointer; background-color: #f0f8ff; transition: background-color 0.2s; }
        textarea:not(.no-modal-editor):hover { background-color: #e6f2ff; }
        .outline-modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.65); z-index: 2000; justify-content: center; align-items: center; padding: 1rem; box-sizing: border-box; }
        .outline-modal-content { background-color: #fdfdfd; padding: 25px; border-radius: 12px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); width: 90vw; height: 90vh; position: relative; animation: fadeIn 0.3s; display: flex; flex-direction: column; }
        .outline-modal-content h3 { margin-top: 0; margin-bottom: 15px; color: #333; font-size: 1.2em; font-weight: 700; }
        #modal-textarea { width: 100%; box-sizing: border-box; font-size: 1.3em; line-height: 1.6; border: 1px solid #ccc; border-radius: 8px; padding: 10px; flex-grow: 1; min-height: 250px; }
        .outline-modal-content .modal-buttons { text-align: right; margin-top: 15px; }
        .outline-modal-content .preview-close-btn { position: absolute; top: 10px; right: 10px; font-size: 2rem; border: none; background: none; cursor: pointer; }
        .btn-action { display: inline-block; padding: 10px 20px; margin: 5px; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: bold; font-family: 'Noto Serif TC', serif; transition: all 0.3s ease; border: none; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.15); color: white; background-color: var(--primary-color); }
        .btn-action:hover { transform: translateY(-2px); box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2); filter: brightness(110%); }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>文章幻燈片 Pro v2.2</h1>
        </header>
        <div class="app-container">
            <div class="input-section">
                <div class="input-header"><i class="fas fa-edit"></i><h2>輸入文章內容</h2></div>
                <div class="input-container">
                    <textarea id="article-input" placeholder="請在此輸入繁體中文文章內容..."></textarea>
                    <div class="char-count">字數: <span id="char-count">0</span></div>
                </div>
                <div class="progress-container" id="progress-container"><div class="progress-bar" id="progress-bar"></div></div>
                <div class="controls">
                    <button id="generate-btn" class="btn btn-primary"><i class="fas fa-magic"></i> 生成幻燈片</button>
                    <button id="save-history-btn" class="btn btn-tertiary"><i class="fas fa-save"></i> 儲存紀錄</button>
                    <button id="history-btn" class="btn btn-tertiary"><i class="fas fa-history"></i> 查看紀錄</button>
                    <button id="reset-btn" class="btn btn-secondary"><i class="fas fa-redo"></i> 重置內容</button>
                </div>
            </div>
            <div class="slides-section">
                <div class="slides-header">
                    <div class="input-header"><i class="fas fa-images"></i><h2>幻燈片展示</h2></div>
                    <button id="export-book-btn" class="btn btn-export" disabled><i class="fas fa-book-open"></i> 匯出為書本</button>
                </div>
                <div class="slides-container" id="slides-container">
                    <div class="placeholder"><i class="fas fa-scroll"></i><p>輸入文章並點擊「生成幻燈片」按鈕後，這裡將顯示帶有AI生成插圖的幻燈片</p></div>
                </div>
                <div class="slide-controls-wrapper">
                    <div id="chapter-nav"></div>
                    <div class="slide-controls">
                        <div class="slide-nav" id="prev-slide" title="上一張"><i class="fas fa-chevron-left"></i></div>
                        <div class="slide-nav" id="next-slide" title="下一張"><i class="fas fa-chevron-right"></i></div>
                    </div>
                </div>
            </div>
        </div>
        <footer><p>© 2025 陳冠健</p></footer>
    </div>
    <div class="notification" id="notification"></div>
    <div id="history-modal" class="modal-overlay">
        <div class="modal-content">
            <h3>歷史紀錄</h3><ul id="history-list"></ul><button id="history-close-btn" class="preview-close-btn" title="關閉" style="color: #333;">&times;</button>
        </div>
    </div>
    <div id="outline-editor-modal" class="outline-modal-overlay">
        <div class="outline-modal-content">
            <h3 id="modal-title">編輯內容</h3><textarea id="modal-textarea" rows="15"></textarea>
            <div class="modal-buttons">
                <button id="modal-ocr-btn" class="btn-action" style="background-color: #17a2b8;">OCR</button>
                <button id="modal-save-btn" class="btn-action">輸入</button>
            </div><button id="modal-close-btn" class="preview-close-btn" title="關閉">&times;</button>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // --- DOM Elements & Constants ---
            const articleInput = document.getElementById('article-input'), charCount = document.getElementById('char-count'), generateBtn = document.getElementById('generate-btn'),
                  resetBtn = document.getElementById('reset-btn'), slidesContainer = document.getElementById('slides-container'), prevSlideBtn = document.getElementById('prev-slide'),
                  nextSlideBtn = document.getElementById('next-slide'), notification = document.getElementById('notification'), progressContainer = document.getElementById('progress-container'),
                  progressBar = document.getElementById('progress-bar'), saveHistoryBtn = document.getElementById('save-history-btn'), historyBtn = document.getElementById('history-btn'),
                  historyModal = document.getElementById('history-modal'), historyList = document.getElementById('history-list'), historyCloseBtn = document.getElementById('history-close-btn'),
                  exportBookBtn = document.getElementById('export-book-btn'), chapterNav = document.getElementById('chapter-nav');
            
            const LS_SESSION_KEY = 'articleSlideshow_currentSession_v2.2', LS_HISTORY_KEY = 'articleSlideshow_history_v2.2', CHUNK_SIZE = 20, SINGLE_CHAPTER_THRESHOLD = 30, RETRY_INTERVAL = 30000;
            let currentSession = {}, retryDaemonID = null;
            const SVG_LOAD = `<svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor"><path d="M12,2A10,10,0,1,0,22,12,10,10,0,0,0,12,2Zm3.71,8.71L12,14.41V8a1,1,0,0,0-2,0v7.41l-1.29-1.3a1,1,0,0,0-1.42,1.42l3,3A1,1,0,0,0,11,18a1,1,0,0,0,.71-.29l3-3a1,1,0,1,0-1.42-1.42Z"/></svg>`,
                  SVG_DELETE = `<svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor"><path d="M20,6H16V5a3,3,0,0,0-3-3H11A3,3,0,0,0,8,5V6H4A1,1,0,0,0,4,8H5V19a3,3,0,0,0,3,3h8a3,3,0,0,0,3-3V8h1a1,1,0,0,0,0-2ZM10,5a1,1,0,0,1,1-1h2a1,1,0,0,1,1,1V6H10Zm7,14a1,1,0,0,1-1,1H8a1,1,0,0,1-1-1V8H17Z"/></svg>`;

            const GOOGLE_TRANSLATE_API_URL = "https://script.google.com/macros/s/AKfycbxkAUF8E8E-F3uQkl4FzbJFkfxidMblHrAvg96kosHk-u6asUKRvC1ngVsP8OdbxATDuQ/exec";
            const MYMEMORY_API_EMAIL = "kenchan20151@gmail.com"; 
            
            // =======================================================
            // ===             CORE HELPER FUNCTIONS               ===
            // =======================================================
            function showNotification(message, isError = false) {
                const icon = isError ? 'fas fa-exclamation-circle' : 'fas fa-check-circle';
                notification.innerHTML = `<i class="${icon}"></i> <span>${message}</span>`;
                notification.className = 'notification';
                if (isError) notification.classList.add('error');
                notification.classList.add('show');
                setTimeout(() => notification.classList.remove('show'), 3500);
            }
            const debounce = (func, delay) => { let timeout; return (...args) => { clearTimeout(timeout); timeout = setTimeout(() => func(...args), delay); }; };

            // =======================================================
            // ===        SESSION & LOCAL STORAGE MANAGEMENT       ===
            // =======================================================
            function saveCurrentSession() { try { localStorage.setItem(LS_SESSION_KEY, JSON.stringify(currentSession)); } catch (e) { console.error("Error saving session:", e); } }
            function loadSessionFromLocalStorage() {
                const savedSession = localStorage.getItem(LS_SESSION_KEY);
                if (savedSession) {
                    try {
                        currentSession = JSON.parse(savedSession);
                        articleInput.value = currentSession.articleText || '';
                        articleInput.dispatchEvent(new Event('input'));
                        renderChapterNav();
                        if (currentSession.chunks && currentSession.chunks.length > 0) {
                            displayChunk(currentSession.activeChunkIndex || 0);
                            showNotification("已成功載入您上次的進度！");
                            startRetryDaemon(); // Resume daemon on load
                        }
                    } catch (e) { localStorage.removeItem(LS_SESSION_KEY); currentSession = {}; }
                } else {
                    currentSession = { articleText: '', chunks: [], slides: {}, activeChunkIndex: 0 };
                }
            }
            const debouncedSaveText = debounce(text => { currentSession.articleText = text; saveCurrentSession(); }, 500);
            articleInput.addEventListener('input', () => { charCount.textContent = articleInput.value.length; debouncedSaveText(articleInput.value); });
            
            // =======================================================
            // ===          CHAPTER & ON-DEMAND LOGIC              ===
            // =======================================================
            function renderChapterNav() {
                chapterNav.innerHTML = '';
                if (!currentSession.chunks || currentSession.chunks.length <= 1) return;

                currentSession.chunks.forEach((_, index) => {
                    const btn = document.createElement('button');
                    btn.className = 'chapter-btn';
                    btn.textContent = `第 ${index + 1} 章`;
                    btn.dataset.chunkIndex = index;
                    if (index === currentSession.activeChunkIndex) {
                        btn.classList.add('active');
                    }
                    chapterNav.appendChild(btn);
                });
            }
            chapterNav.addEventListener('click', e => {
                if (e.target.matches('.chapter-btn')) {
                    const index = parseInt(e.target.dataset.chunkIndex, 10);
                    if (index !== currentSession.activeChunkIndex) {
                        currentSession.activeChunkIndex = index;
                        displayChunk(index); // Just display, generation is handled in the background
                    }
                }
            });

            function displayChunk(chunkIndex) {
                currentSession.activeChunkIndex = chunkIndex;
                chapterNav.querySelectorAll('.chapter-btn').forEach(btn => {
                    btn.classList.toggle('active', parseInt(btn.dataset.chunkIndex, 10) === chunkIndex);
                });

                const chunkParagraphs = currentSession.chunks[chunkIndex] || [];
                const startSlideIndex = chunkIndex * CHUNK_SIZE;
                const chunkSlides = chunkParagraphs.map((p, i) => currentSession.slides[startSlideIndex + i] || { paragraph: p, status: 'pending' });
                
                slidesContainer.innerHTML = '';
                if (chunkSlides.length === 0) {
                    slidesContainer.innerHTML = `<div class="placeholder"><i class="fas fa-scroll"></i><p>此章節無內容</p></div>`;
                    return;
                }
                
                chunkSlides.forEach((slideData, indexInChunk) => {
                    const globalIndex = startSlideIndex + indexInChunk;
                    const slideElement = document.createElement('div');
                    slideElement.className = 'slide';
                    slideElement.dataset.globalIndex = globalIndex;
                    slideElement.dataset.paragraph = slideData.paragraph;

                    let imageContent = '';
                    if (slideData.status === 'success') {
                        imageContent = `<img src="${slideData.imageUrl}" alt="幻燈片插圖" style="cursor: pointer;" title="點擊以重新生成此圖片">`;
                    } else if (slideData.status === 'error') {
                        imageContent = `<div class="generation-error" data-action="retry-generation" title="點擊以重新生成此圖片"><i class="fas fa-sync-alt"></i><p>${slideData.error || '生成失敗'}<br>點擊重試</p></div>`;
                    } else {
                        imageContent = `<div class="loading"><div class="spinner"></div></div>`;
                    }

                    slideElement.innerHTML = `
                        <div class="slide-header"><span>幻燈片 ${globalIndex + 1}</span><span>${slideData.paragraph.length} 字</span></div>
                        <div class="slide-image">${imageContent}</div>
                        <div class="slide-text"><p>${slideData.paragraph}</p></div>`;
                    slidesContainer.appendChild(slideElement);
                });

                prevSlideBtn.disabled = false;
                nextSlideBtn.disabled = false;
                const hasAnyGeneratedSlides = Object.values(currentSession.slides).some(s => s.status === 'success');
                exportBookBtn.disabled = !hasAnyGeneratedSlides;
                saveCurrentSession();
            }

            // =======================================================
            // ===                 RESET & HISTORY                 ===
            // =======================================================
            resetBtn.addEventListener('click', () => {
                if (!confirm("您確定要重置所有內容嗎？目前進度將會遺失。")) return;
                currentSession = { articleText: '', chunks: [], slides: {}, activeChunkIndex: 0 };
                saveCurrentSession();
                articleInput.value = '';
                articleInput.dispatchEvent(new Event('input'));
                slidesContainer.innerHTML = `<div class="placeholder"><i class="fas fa-scroll"></i><p>輸入文章並點擊「生成幻燈片」按鈕後，這裡將顯示帶有AI生成插圖的幻燈片</p></div>`;
                chapterNav.innerHTML = '';
                prevSlideBtn.disabled = true;
                nextSlideBtn.disabled = true;
                exportBookBtn.disabled = true;
                progressContainer.style.display = 'none';
                progressBar.style.width = '0%';
                if (retryDaemonID) clearInterval(retryDaemonID);
                retryDaemonID = null;
                showNotification('已重置所有內容！');
            });
            saveHistoryBtn.addEventListener('click', () => {
                 if (!currentSession.articleText || Object.keys(currentSession.slides).length === 0) { showNotification("請先生成幻燈片再儲存", true); return; }
                const history = JSON.parse(localStorage.getItem(LS_HISTORY_KEY) || '[]');
                const newEntry = { id: Date.now(), title: currentSession.articleText.substring(0, 40) + '...', session: currentSession };
                history.unshift(newEntry);
                localStorage.setItem(LS_HISTORY_KEY, JSON.stringify(history));
                showNotification("成功儲存至歷史紀錄！");
            });
            historyBtn.addEventListener('click', () => { renderHistoryList(); historyModal.style.display = 'flex'; });
            historyCloseBtn.addEventListener('click', () => historyModal.style.display = 'none');
            function renderHistoryList() {
                const history = JSON.parse(localStorage.getItem(LS_HISTORY_KEY) || '[]');
                historyList.innerHTML = history.length === 0 ? '<p>尚無歷史紀錄。</p>' : '';
                history.forEach(item => {
                    const li = document.createElement('li'); li.className = 'history-item';
                    li.innerHTML = `<span class="history-item-title" title="${item.title}">${item.title}</span><div class="history-item-actions"><button class="history-icon-btn" title="載入紀錄" data-id="${item.id}" data-action="load">${SVG_LOAD}</button><button class="history-icon-btn" title="刪除紀錄" data-id="${item.id}" data-action="delete">${SVG_DELETE}</button></div>`;
                    historyList.appendChild(li);
                });
            }
            historyList.addEventListener('click', (e) => {
                const button = e.target.closest('.history-icon-btn'); if (!button) return;
                const action = button.dataset.action; const id = parseInt(button.dataset.id, 10);
                let history = JSON.parse(localStorage.getItem(LS_HISTORY_KEY) || '[]');
                if (action === 'load' && confirm("載入此紀錄將會覆蓋您目前的進度，確定要繼續嗎？")) {
                    const itemToLoad = history.find(item => item.id === id);
                    if (itemToLoad) { currentSession = itemToLoad.session; saveCurrentSession(); loadSessionFromLocalStorage(); historyModal.style.display = 'none'; }
                } else if (action === 'delete' && confirm("您確定要永久刪除此項紀錄嗎？")) {
                    history = history.filter(item => item.id !== id); localStorage.setItem(LS_HISTORY_KEY, JSON.stringify(history)); renderHistoryList(); showNotification("紀錄已刪除");
                }
            });

            // =======================================================
            // ===               EXPORT BOOK FUNCTION              ===
            // =======================================================
             async function convertImgToBase64(url) { try { const response = await fetch(url); const blob = await response.blob(); return new Promise((resolve, reject) => { const reader = new FileReader(); reader.onloadend = () => resolve(reader.result); reader.onerror = reject; reader.readAsDataURL(blob); }); } catch (e) { return 'https://via.placeholder.com/400?text=Image+Load+Error'; } }
            exportBookBtn.addEventListener('click', async () => {
                showNotification("正在準備您的書本...");
                if (Object.keys(currentSession.slides).length === 0) { showNotification("沒有可匯出的幻燈片", true); return; }

                let pagesHtml = `<div class="page cover"><h1>${currentSession.articleText.substring(0, 50)}...</h1></div><div class="page back"></div>`;
                const allSlides = Object.values(currentSession.slides).filter(s => s.status === 'success');

                for (let i = 0; i < allSlides.length; i++) {
                    const slide = allSlides[i];
                    if (currentSession.chunks.length > 1 && i % CHUNK_SIZE === 0) {
                        const chapterNum = (i / CHUNK_SIZE) + 1;
                        pagesHtml += `<div class="page chapter-title"><h2>第 ${chapterNum} 章</h2></div><div class="page back"></div>`;
                    }
                    const imageSrc = await convertImgToBase64(slide.imageUrl);
                    pagesHtml += `<div class="page"><div class="page-content"><img src="${imageSrc}" alt="Slide image ${i + 1}"><p>${slide.paragraph}</p></div></div><div class="page back"></div>`;
                }

                const bookHtml = `<!DOCTYPE html><html lang="zh-TW"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>Exported Book</title><style>body{margin:0;font-family:'Noto Serif TC',serif;background-color:#f0f4f8;display:flex;justify-content:center;align-items:center;min-height:100vh;overflow:hidden}#book-container{width:90vw;height:80vh;max-width:1200px}.book{width:100%;height:100%;position:relative;transform-style:preserve-3d;transition:transform .5s}.page{position:absolute;width:50%;height:100%;top:0;background-color:#fff;box-shadow:0 0 20px rgba(0,0,0,.2);transform-origin:left;transition:transform .8s ease-in-out;backface-visibility:hidden;display:flex;justify-content:center;align-items:center;overflow:hidden}.page.right{left:50%;transform-origin:left;border-left:1px solid #ccc}.page.left{left:0;transform-origin:right;border-right:1px solid #ccc}.page.flipped{transform:rotateY(-180deg)}.page .page-content{padding:30px;display:flex;flex-direction:column;height:100%;width:100%;box-sizing:border-box}.page img{width:100%;height:50%;object-fit:cover;border-radius:8px;margin-bottom:20px}.page p{font-size:1.1em;line-height:1.7;flex-grow:1;overflow-y:auto}.cover h1{font-size:2.5em;padding:20px}.chapter-title h2{font-size:3em;color:#4a5568}.back{background-color:#f7f7f7}#prev-btn,#next-btn{position:fixed;top:50%;transform:translateY(-50%);background:rgba(0,0,0,.5);color:white;border:none;padding:15px;border-radius:50%;cursor:pointer;z-index:1000}#prev-btn{left:20px}#next-btn{right:20px}@media (max-width:768px){body{overflow:auto}#book-container{height:auto;width:100%}.book{position:relative;height:auto;transform-style:flat}.page,.page.left,.page.right{position:relative!important;width:90%;margin:20px auto;left:0!important;height:auto;transform:none!important;box-shadow:0 5px 15px rgba(0,0,0,.1)}.page.back{display:none}#prev-btn,#next-btn{display:none}}</style></head><body><div id="book-container"><div class="book" id="book">${pagesHtml}</div></div><button id="prev-btn">&lt;</button><button id="next-btn">&gt;</button><script>const book=document.getElementById("book"),pages=Array.from(book.getElementsByClassName("page")),prevBtn=document.getElementById("prev-btn"),nextBtn=document.getElementById("next-btn");let currentLocation=0;const totalLocations=pages.length/2;pages.forEach((page,i)=>{if(i%2===0){page.classList.add("left");page.style.zIndex=pages.length-i}else{page.classList.add("right");page.style.zIndex=pages.length-i}});function openBook(){book.style.transform="translateX(50%)";prevBtn.style.transform="translateX(-180px)";nextBtn.style.transform="translateX(180px)"}function closeBook(isAtBeginning){book.style.transform=isAtBeginning?"translateX(0)":"translateX(100%)";prevBtn.style.transform="translateX(0)";nextBtn.style.transform="translateX(0)"}function goNextPage(){if(currentLocation<totalLocations){if(currentLocation===0)openBook();const currentPage=pages[currentLocation*2];const nextPage=pages[currentLocation*2+1];currentPage.classList.add("flipped");nextPage.classList.add("flipped");currentLocation++;if(currentLocation===totalLocations)closeBook(false)}}function goPrevPage(){if(currentLocation>0){currentLocation--;const prevPage=pages[currentLocation*2];const prevNextPage=pages[currentLocation*2+1];prevPage.classList.remove("flipped");prevNextPage.classList.remove("flipped");if(currentLocation===0)closeBook(true)}}nextBtn.addEventListener("click",goNextPage);prevBtn.addEventListener("click",goPrevPage);<\/script></body></html>`;
                const blob = new Blob([bookHtml], { type: 'text/html' });
                const link = document.createElement('a'); link.href = URL.createObjectURL(blob);
                link.download = 'digital-book.html'; link.click(); URL.revokeObjectURL(link.href);
                showNotification("書本匯出完成！", false);
            });

            // =======================================================
            // ===        API & GENERATION CORE LOGIC              ===
            // =======================================================
            async function translateWithFallback(text) {
                if (GOOGLE_TRANSLATE_API_URL) {
                    try { const response = await fetch(GOOGLE_TRANSLATE_API_URL, { method: 'POST', mode: 'cors', headers: { 'Content-Type': 'text/plain;charset=utf-8' }, body: JSON.stringify({ text: text, source_lang: 'zh-TW', target_lang: 'en' }) }); if (!response.ok) throw new Error('Google API non-200'); const data = await response.json(); if (data.translatedText) return data.translatedText; throw new Error(data.error || 'Invalid Google API response'); } catch (error) { console.warn('Primary translation API failed, trying fallback. Error:', error); }
                }
                try { const apiUrl = `https://api.mymemory.translated.net/get?q=${encodeURIComponent(text)}&langpair=zh-TW|en&de=${MYMEMORY_API_EMAIL}`; const response = await fetch(apiUrl); if (!response.ok) throw new Error(`MyMemory API status ${response.status}`); const data = await response.json(); if (data.responseStatus !== 200) throw new Error(data.responseDetails || 'Daily limit likely exceeded'); return data.responseData.translatedText; } catch (error) { throw error; }
            }
            function generateImagePrompt(englishParagraph) { return `Illustration of: "${englishParagraph}". Rendered in a classic manga style with an emphasis on simplicity. Use only black and white, with clean, uniform, and minimalist line art. The overall feel should be a high-contrast, clear monochrome comic panel or sketch. No text is included`; }
            async function generateImageWithRetries(prompt, baseSeed) { const imageUrl = `https://image.pollinations.ai/prompt/${encodeURIComponent(prompt)}?token=Jeq-UCxbpvrqUEzN&model=flux&enhance=false&private=true&nologo=true&seed=${baseSeed}`; const response = await fetch(imageUrl, {mode: 'cors'}); if (!response.ok || !response.headers.get('content-type')?.startsWith('image')) throw new Error(`無效圖片回應`); return imageUrl; }
            
            async function processSingleSlide(globalIndex) {
                const slideData = currentSession.slides[globalIndex];
                const slideElement = slidesContainer.querySelector(`[data-global-index="${globalIndex}"]`);
                const imageContainer = slideElement ? slideElement.querySelector('.slide-image') : null;
                if (imageContainer && !imageContainer.querySelector('.spinner')) { imageContainer.innerHTML = `<div class="loading"><div class="spinner"></div><p>處理中...</p></div>`; }
                try {
                    const englishPara = await translateWithFallback(slideData.paragraph);
                    const prompt = generateImagePrompt(englishPara);
                    const imageUrl = await generateImageWithRetries(prompt, Date.now());
                    currentSession.slides[globalIndex] = { ...slideData, imageUrl, status: 'success', error: null };
                    if (imageContainer) { imageContainer.innerHTML = `<img src="${imageUrl}" alt="幻燈片插圖" style="cursor: pointer;" title="點擊以重新生成此圖片">`; }
                } catch (error) {
                    const errorMessage = error.message || '未知錯誤';
                    currentSession.slides[globalIndex] = { ...slideData, imageUrl: null, status: 'error', error: errorMessage };
                    if (imageContainer) { imageContainer.innerHTML = `<div class="generation-error" data-action="retry-generation" title="點擊以重新生成此圖片"><i class="fas fa-sync-alt"></i><p>${errorMessage}<br>點擊重試</p></div>`; }
                }
                saveCurrentSession();
            }

            function startRetryDaemon() {
                if (retryDaemonID) clearInterval(retryDaemonID);
                retryDaemonID = setInterval(async () => {
                    const failedSlideIndex = Object.keys(currentSession.slides).find(index => currentSession.slides[index].status === 'error');
                    if (failedSlideIndex) {
                        console.log(`重試 Daemon: 發現錯誤幻燈片 #${parseInt(failedSlideIndex, 10) + 1}。正在重試...`);
                        await processSingleSlide(parseInt(failedSlideIndex, 10));
                    }
                }, RETRY_INTERVAL);
            }

            // =======================================================
            // ===            MAIN TRIGGER FUNCTIONS               ===
            // =======================================================
            function splitArticleIntoParagraphs(article) { const sentences = article.split(/(?<=[。！？；])/g); const paragraphs = []; let currentParagraph = ''; sentences.forEach(sentence => { if ((currentParagraph + sentence).length <= 100) currentParagraph += sentence; else { if (currentParagraph.trim()) paragraphs.push(currentParagraph.trim()); currentParagraph = sentence; } }); if (currentParagraph.trim()) paragraphs.push(currentParagraph.trim()); return paragraphs.filter(p => p.trim() !== ''); }
            
            generateBtn.addEventListener('click', async function() {
                const article = articleInput.value.trim();
                if (!article) { showNotification('請輸入文章內容！', true); return; }
                const paragraphs = splitArticleIntoParagraphs(article);
                currentSession = { articleText: article, chunks: [], slides: {}, activeChunkIndex: 0 };
                
                if (paragraphs.length <= SINGLE_CHAPTER_THRESHOLD) {
                    currentSession.chunks.push(paragraphs);
                } else {
                    for (let i = 0; i < paragraphs.length; i += CHUNK_SIZE) {
                        currentSession.chunks.push(paragraphs.slice(i, i + CHUNK_SIZE));
                    }
                }
                
                saveCurrentSession();
                renderChapterNav();
                
                // --- Start Generation ---
                generateBtn.disabled = true; resetBtn.disabled = true;
                progressContainer.style.display = 'block'; progressBar.style.width = '0%';

                await generateSlidesForChunk(0, true); // Generate first chunk and show progress

                if (currentSession.chunks.length > 1) {
                    showNotification("第一章已生成！其餘章節將在背景自動生成。");
                    startBackgroundGeneration();
                    startRetryDaemon();
                } else {
                     startRetryDaemon(); // Also start for short articles
                }
                
                generateBtn.disabled = false; resetBtn.disabled = false;
            });

            async function startBackgroundGeneration() {
                 for (let i = 1; i < currentSession.chunks.length; i++) {
                    const firstSlideOfChunkIndex = i * CHUNK_SIZE;
                    if (!currentSession.slides[firstSlideOfChunkIndex]) { 
                         await generateSlidesForChunk(i, false); // Generate subsequent chunks without progress bar
                    }
                }
                showNotification("所有章節已在背景生成完畢！");
            }

            async function generateSlidesForChunk(chunkIndex, showProgress) {
                if(showProgress) { progressBar.style.width = '0%'; }
                
                const chunkParagraphs = currentSession.chunks[chunkIndex];
                const startSlideIndex = chunkIndex * CHUNK_SIZE;
                chunkParagraphs.forEach((p, i) => { if (!currentSession.slides[startSlideIndex + i]) currentSession.slides[startSlideIndex + i] = { paragraph: p, status: 'pending' }; });
                if (currentSession.activeChunkIndex === chunkIndex) displayChunk(chunkIndex);

                let completedCount = 0;
                for (let i = 0; i < chunkParagraphs.length; i++) {
                    const globalIndex = startSlideIndex + i;
                    await processSingleSlide(globalIndex);
                    if(showProgress) {
                        completedCount++;
                        progressBar.style.width = `${(completedCount / chunkParagraphs.length) * 100}%`;
                    }
                }
                if(showProgress) {
                     showNotification(`第 ${chunkIndex + 1} 章生成完成！`);
                     progressContainer.style.display = 'none';
                }
            }

            slidesContainer.addEventListener('click', async function(event) {
                const retryTrigger = event.target.closest('[data-action="retry-generation"]');
                if (retryTrigger) {
                    const slideElement = retryTrigger.closest('.slide');
                    if (slideElement && slideElement.dataset.globalIndex) {
                        const globalIndex = parseInt(slideElement.dataset.globalIndex, 10);
                        showNotification(`正在手動重試幻燈片 ${globalIndex + 1}...`);
                        await processSingleSlide(globalIndex);
                    }
                }
            });

            // =======================================================
            // ===          SLIDE NAVIGATION & INIT                ===
            // =======================================================
            prevSlideBtn.addEventListener('click', () => { slidesContainer.scrollBy({ left: -430, behavior: 'smooth' }); });
            nextSlideBtn.addEventListener('click', () => { slidesContainer.scrollBy({ left: 430, behavior: 'smooth' }); });
            loadSessionFromLocalStorage();
            
            // =======================================================
            // ===        ORIGINAL MODAL EDITOR SCRIPT (KEPT)        ===
            // =======================================================
            const modal = document.getElementById('outline-editor-modal'), modalTextarea = document.getElementById('modal-textarea'), modalTitle = document.getElementById('modal-title'),
                  modalSaveBtn = document.getElementById('modal-save-btn'), modalCloseBtn = document.getElementById('modal-close-btn'), ocrBtn = document.getElementById('modal-ocr-btn');
            if(modal) {
                let currentEditingElement = null;
                const openModalEditor = (element) => { currentEditingElement = element; modalTextarea.value = currentEditingElement.value; modalTitle.textContent = element.id === 'article-input' ? '輸入文章內容' : '編輯內容'; modal.style.display = 'flex'; modalTextarea.focus(); };
                const closeModalEditor = () => { modal.style.display = 'none'; currentEditingElement = null; };
                const saveAndCloseEditor = () => { if (currentEditingElement) { currentEditingElement.value = modalTextarea.value; currentEditingElement.dispatchEvent(new Event('input', { bubbles: true })); } closeModalEditor(); };
                document.body.addEventListener('click', (event) => { if (event.target.id === 'article-input' && event.target.tagName === 'TEXTAREA') { event.preventDefault(); openModalEditor(event.target); } });
                modalSaveBtn.addEventListener('click', saveAndCloseEditor); modalCloseBtn.addEventListener('click', closeModalEditor);
                modal.addEventListener('click', (event) => { if (event.target === modal) closeModalEditor(); });
                let ocrWindow = null; const VERCEL_OCR_URL = 'https://gemini-ocr-proxy.vercel.app/';
                ocrBtn.addEventListener('click', () => { if (ocrWindow && !ocrWindow.closed) { ocrWindow.focus(); return; } ocrWindow = window.open(VERCEL_OCR_URL, 'OCRWindow', 'width=650,height=850,scrollbars=yes,resizable=yes'); });
                window.addEventListener('message', (event) => { if (event.origin !== new URL(VERCEL_OCR_URL).origin) return; if (event.data && event.data.type === 'ocrResult') { modalTextarea.value += (modalTextarea.value.trim() ? '\n' : '') + event.data.text; if (ocrWindow) ocrWindow.close(); modalTextarea.focus(); } });
            }
        });
    </script>
</body>
</html>